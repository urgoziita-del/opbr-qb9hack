<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Discord認証ページ</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 40px;
    }
    a.button {
      display: inline-block;
      padding: 12px 24px;
      background: #5865F2;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2 id="title">Discord認証へようこそ</h2>
  <div id="content">
    <p>以下のボタンを押して認証してください。</p>
    <a id="login-btn" 
       class="button"
       href="https://discord.com/oauth2/authorize?client_id=1434614207986274364&redirect_uri=https%3A%2F%2Furgoziita-del.github.io%2Fopbr-qb9hack%2Findex.html&response_type=token&scope=identify%20guilds">
       Discordでログイン
    </a>
  </div>

  <script>
    // --- あなたのサーバーID ---
    const TARGET_GUILD_ID = "1431917745418670111";

    // --- 認証後（トークン付きURL）なら処理を実行 ---
    function parseHash() {
      const h = location.hash.replace(/^#/, '');
      if (!h) return null;
      const params = new URLSearchParams(h);
      return {
        access_token: params.get('access_token'),
        token_type: params.get('token_type'),
        expires_in: params.get('expires_in')
      };
    }

    async function checkUser() {
      const token = parseHash();
      if (!token || !token.access_token) return; // 通常時はそのまま

      document.getElementById("title").innerText = "認証情報を確認中…";
      document.getElementById("content").innerHTML = "お待ちください…";

      // ユーザー情報取得
      const userResp = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `${token.token_type} ${token.access_token}` }
      });
      const user = await userResp.json();

      // サーバー所属確認
      const guildsResp = await fetch("https://discord.com/api/users/@me/guilds", {
        headers: { Authorization: `${token.token_type} ${token.access_token}` }
      });
      const guilds = await guildsResp.json();

      const inGuild = guilds.some(g => g.id === TARGET_GUILD_ID);

      if (inGuild) {
        document.getElementById("title").innerText = "✅ 認証成功！";
        document.getElementById("content").innerHTML = `
          <p><strong>${user.username}#${user.discriminator}</strong> さんはこのサーバーに参加しています。</p>
          <p>ID: ${user.id}</p>
        `;
      } else {
        document.getElementById("title").innerText = "❌ 認証失敗";
        document.getElementById("content").innerHTML = `
          <p>このアカウントはサーバーに参加していません。</p>
          <p><a class="button" href="https://t.co/UHWa0OqGKt">サーバーに参加する</a></p>
        `;
      }
    }

    checkUser();
  </script>
</body>
</html>
